<!DOCTYPE html>
<html>
	<head>
		<script>
			const selectedDice = [];
			
			window.onload = init;

			function init(){
				// the code to be called when the dom has loaded
				// #document has its nodes
				var table = document.getElementById("diceTable");
				table.addEventListener("click", (event) => {
					if (event.target.matches("button.roll")) {
						rollIndividualDice(event.target);
					}
				});
			}

			function rollIndividualDice(element) {		
				const row = element.closest("tr");
				return rollDiceForRow(row);
			}
			
			function rollDiceForRow(row) {
				const rollValueElement = row.cells[row.cells.length - 1];
				let diceTypeElement = row.querySelector("select");
				const maximumValue = diceTypeElement.value;
				const rollValue = getRndInteger(1, maximumValue);
				
				// <p>Total: <span id="totalRollValue" style="color:blue"></span></p>
				var rollValueHTML = "";
				// Rolled a natural 1.
				if (rollValue == 1) {
					rollValueHTML = "<p>Roll: <span style='color:red'>" + rollValue + " (Fumble)</span></p>";
				// Rolled a crit.
				} else if (rollValue == maximumValue) {
					rollValueHTML = "<p>Roll: <span style='color:green'>" + rollValue + " (Crit)</span></p>";
				// Rolled a normal number.
				} else {
					rollValueHTML = "<p>Roll: " + rollValue + "</p>";
				}
				// TODO: Some text colouring?
				rollValueElement.innerHTML = rollValueHTML;
				return rollValue;
			}
			
			function getRndInteger(min, max) {
				return Math.floor((Math.random() * max) + min);
			}
			
			function createRow() {
				var row = document.createElement("tr");
				var removeRowColumn = document.createElement("td");
				var diceTypeColumn = document.createElement("td");
				var rollButtonColumn = document.createElement("td");
				var rollValueColumn = document.createElement("td");
				
				row.appendChild(removeRowColumn);
				row.appendChild(diceTypeColumn);
				row.appendChild(rollButtonColumn);
				row.appendChild(rollValueColumn);
				
				removeRowColumn.innerHTML = "<button class='remove' onclick='removeRow(this)'>Remove</button>";
				diceTypeColumn.innerHTML = "<select class='diceType'>" +
						"<option value='2'>d2</option>" +
						"<option value='4'>d4</option>" +
						"<option value='6'>d6</option>" +
						"<option value='8'>d8</option>" +
						"<option value='10'>d10</option>" +
						"<option value='12'>d12</option>" +
						"<option value='20'>d20</option>" +
					"</select>";
				rollButtonColumn.innerHTML = "<button class='roll'>Roll</button>";
				rollValueColumn.innerHTML = "<p></p>";
				
				var table = document.getElementById("diceTable");
				table.appendChild(row);
			}
			
			function removeRow(element) {
				const row = element.closest("tr");
				var table = document.getElementById("diceTable");
				table.deleteRow(row.rowIndex);
			}
			
			function rollAllDice() {
				var table = document.getElementById("diceTable");
				
				calculatedTotal = 0;
				for (let i = 1; i < table.rows.length; i++) { 
					var row = table.rows[i];
					calculatedTotal += rollDiceForRow(row);
					//alert(row.cells.length);
				};
				document.getElementById("totalRollValue").innerHTML = calculatedTotal;
				
				return calculatedTotal;
			}
		</script>
	</head>
	<body>
		<h1>Renegade Dice Roller</h1>
		<table id="diceTable">
			<tr>
				<td>
					<button class="add" onclick="createRow()">Add</button>
				</td>
			</tr>
			<tr class="tableRow">
				<td>
					<button class="remove" onclick="removeRow(this)">Remove</button>
				</td>
				<td>
					<select class="diceType">
						<option value="2">d2</option>
						<option value="4">d4</option>
						<option value="6">d6</option>
						<option value="8">d8</option>
						<option value="10">d10</option>
						<option value="12">d12</option>
						<option value="20">d20</option>
					</select>
				</td>
				<td>
					<button class="roll">Roll</button>
				</td>
				<td>
					<p></p>
				</td>
			</tr>
		</table>
		<button onclick="rollAllDice()">Roll All</button>
		<p>Total: <span id="totalRollValue" style="color:blue"></span></p>
	</body>
</html>